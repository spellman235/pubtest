/**
 * Top-level build file |1|
 * Allows configuration options common to all sub-projects/modules.
 */

ext {
    ignoreBddFailures = project.hasProperty('ignoreBddFailures') ? project.getProperty('ignoreBddFailures') : 'true'
}

//The buildScript block determines which plugins, task classes and other classes are available for use in the rest of the build script.
buildscript {
    //The repositories block specifies the location of artifactory to download the required dependencies
    repositories {

        maven { 
           url 'http://172.16.2.42:8082/artifactory/a-gradle-release'
                credentials {
                            username = "admin"
                            password = "Password1"
                 }
        }

    }

    //The dependencies block represents the required plugins to be downloaded from the artifactory and adds into the project classpath.
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:2.1.1.RELEASE")
    }
}

//The war plugin creates the application artifact as war/zip package.
apply plugin: 'war'

//The springboot plugin required for the spring boot application
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

//The repositories block specifies the location of artifactory to download the war, java, springboot plugins and dependencies.

apply plugin: 'maven-publish'

publishing{
    publications{
        mavenWeb(MavenPublication){
            from components.web
        }
        mavenJava(MavenPublication){
            from components.java
        }
    }
}
//The dependencies block represents the application dependencies are required to compile and build the artifact.
dependencies {
    compile('org.springframework.boot:spring-boot-starter-actuator')
    compile('org.springframework.boot:spring-boot-starter-thymeleaf')
    compile('org.springframework.boot:spring-boot-starter-web')

    compile('com.fasterxml.jackson.core:jackson-annotations:2.9.6')
    compile('com.fasterxml.jackson.core:jackson-core:2.9.6')
    compile('com.fasterxml.jackson.core:jackson-databind:2.9.9')

    testCompile('org.springframework.boot:spring-boot-starter-test')
    providedRuntime('org.springframework.boot:spring-boot-starter-tomcat')
    compile project(':doedemodepend')
    testCompile('io.cucumber:cucumber-java8:4.2.6')
    testCompile('io.cucumber:cucumber-junit:4.2.6')
    testCompile('io.cucumber:cucumber-spring:4.2.6')
}

task bddTest(type: Test) {
    testLogging.showStandardStreams = true
    doFirst {
        if (System.getProperty("cucumber.options") != null) {
            System.setProperty("cucumber.options", System.getProperty("cucumber.options") //options from pipeline should only be tags
                    + " -p html:${buildDir}/cucumber/cucumber.html -p json:${buildDir}/cucumber/cucumber.json")
        } else {
            System.setProperty("cucumber.options",
                    " -p html:${buildDir}/cucumber/cucumber.html -p json:${buildDir}/cucumber/cucumber.json")
        }
        systemProperties System.getProperties() as Map<String, ?>
    }
    ignoreFailures = "${ignoreBddFailures}".toBoolean()
    outputs.upToDateWhen { false }
}
test.onlyIf {project.hasProperty("integrationTests")}
bddTest.onlyIf {project.hasProperty("integrationTests")}
